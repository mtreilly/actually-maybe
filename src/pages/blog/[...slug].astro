---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content, headings } = await render(post);

// Extract body text for reading time calculation
const bodyText = post.body || '';

// Get all posts sorted by date for next/previous navigation
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Find current post index
const currentIndex = sortedPosts.findIndex(p => p.id === post.id);
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

// Find related posts based on shared topics with improved relevance scoring
const now = Date.now();
const oneYearAgo = now - (365 * 24 * 60 * 60 * 1000);

const relatedPosts = allPosts
	.filter(p => {
		// Exclude current post
		if (p.id === post.id) return false;
		// Check if any topics overlap
		return p.data.topics.some(topic => post.data.topics.includes(topic));
	})
	.map(p => {
		const sharedTopics = p.data.topics.filter(topic => post.data.topics.includes(topic)).length;
		// Calculate recency score (prefer posts from last year)
		const postAge = now - p.data.pubDate.valueOf();
		const recencyScore = postAge < oneYearAgo ? 0.5 : 1.0; // Penalize posts older than 1 year
		// Combine shared topics with recency weighting
		const relevanceScore = sharedTopics * recencyScore;

		return {
			...p,
			sharedTopics,
			relevanceScore,
		};
	})
	.sort((a, b) => {
		// Sort by combined relevance score (topics + recency)
		if (b.relevanceScore !== a.relevanceScore) return b.relevanceScore - a.relevanceScore;
		// Break ties with most recent first
		return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
	})
	.slice(0, 3); // Limit to 3 related posts
---

<BlogPost
	{...post.data}
	relatedPosts={relatedPosts}
	nextPost={nextPost}
	prevPost={prevPost}
	headings={headings}
	bodyText={bodyText}
	allPosts={allPosts}
	postId={post.id}
>
	<Content />
</BlogPost>
