---
import { buildAssistantLinks } from '../utils/aiLinks';

type Props = {
	postId: string;
	title: string;
	description?: string;
};

const { postId, title, description = '' } = Astro.props as Props;
const markdownPath = `/blog/${postId}.md`;
const absoluteMarkdownUrl = new URL(markdownPath, Astro.url).toString();
const canonicalPageUrl = new URL(`/blog/${postId}/`, Astro.url).toString();
const assistantLinks = buildAssistantLinks({
	markdownUrl: absoluteMarkdownUrl,
	canonicalUrl: canonicalPageUrl,
	title,
	description,
});
---

<div class="llm-menu-wrapper">
	<details
		class="llm-menu"
		data-assist-menu="true"
		data-markdown-url={markdownPath}
		data-markdown-link={absoluteMarkdownUrl}
		data-page-url={canonicalPageUrl}
		data-chatgpt-url={assistantLinks.chatgpt}
		data-claude-url={assistantLinks.claude}
		data-title={title}
		data-description={description}
	>
		<summary class="assist-toggle" data-assist-toggle role="button" tabindex="0">
			<span class="summary-label">Copy Markdown</span>
		</summary>
		<div class="assist-panel" data-assist-panel hidden>
			<p class="panel-label">One-click exports</p>
			<div class="menu-items">
				<button type="button" data-assist-action="copy-markdown">Copy markdown</button>
				<button type="button" data-assist-action="copy-link">Copy .md link</button>
				<button type="button" data-assist-action="open-chatgpt">Open in ChatGPT</button>
				<button type="button" data-assist-action="open-claude">Open in Claude</button>
			</div>
			<p class="panel-hint">Shortcut: Shift+Cmd+M</p>
		</div>
	</details>
</div>

<style>
	.llm-menu-wrapper {
		margin-top: 0;
		display: flex;
		justify-content: flex-end;
	}

	.llm-menu {
		border: none;
		border-radius: 0;
		padding: 0;
		background: transparent;
		max-width: 320px;
		position: relative;
	}

	.assist-toggle {
		width: auto;
		border: none;
		background: transparent;
		padding: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		cursor: pointer;
		border-radius: 0;
		color: rgb(var(--gray));
		font-size: 0.85rem;
		transition: color 0.2s ease;
	}

	.assist-toggle::-webkit-details-marker {
		display: none;
	}

	.assist-toggle:hover,
	.assist-toggle:focus-visible {
		color: rgb(var(--black));
		background: transparent;
		outline: none;
	}

	.summary-label {
		font-weight: 400;
		font-size: 0.85rem;
		text-decoration: underline;
		text-decoration-color: currentColor;
		text-decoration-thickness: 1px;
		text-underline-offset: 3px;
	}

	.summary-meta {
		display: none;
	}

	.assist-panel {
		position: absolute;
		top: calc(100% + 0.5rem);
		right: 0;
		width: 200px;
		background: #f8f8f8;
		border: 1px solid #e5e5e5;
		border-radius: 6px;
		padding: 0.75rem;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		z-index: 10;
	}

	.panel-label {
		margin: 0 0 0.5rem 0;
		font-size: 0.7rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: #666;
	}

	.panel-hint {
		margin: 0.5rem 0 0 0;
		font-size: 0.7rem;
		color: #666;
	}

	.menu-items {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}

	.menu-items button {
		width: 100%;
		border: none;
		background: transparent;
		color: #333;
		padding: 0.5rem 0.5rem;
		border-radius: 3px;
		font-size: 0.8rem;
		text-align: left;
		cursor: pointer;
		transition: background 0.15s ease, color 0.15s ease;
		font-weight: 400;
	}

	.menu-items button:hover,
	.menu-items button:focus-visible {
		border: none;
		background: #efefef;
		color: #000;
		outline: none;
	}

	/* Dark mode styling */
	[data-theme="dark"] .assist-panel {
		background: #2a2a2a;
		border-color: #404040;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
	}

	[data-theme="dark"] .panel-label,
	[data-theme="dark"] .panel-hint {
		color: #999;
	}

	[data-theme="dark"] .menu-items button {
		color: #d0d0d0;
	}

	[data-theme="dark"] .menu-items button:hover,
	[data-theme="dark"] .menu-items button:focus-visible {
		background: #3a3a3a;
		color: #e8e8e8;
	}

	@media (max-width: 640px) {
		.llm-menu-wrapper {
			margin-top: 0;
		}

		.llm-menu {
			width: 100%;
			max-width: unset;
		}

		.assist-panel {
			position: fixed;
			top: auto;
			bottom: 0;
			right: 0;
			left: 0;
			width: 100%;
			border-radius: 12px 12px 0 0;
			max-height: 50vh;
			overflow-y: auto;
		}
	}
</style>
