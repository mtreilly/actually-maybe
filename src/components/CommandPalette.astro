---
import { getCollection } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../utils/readingTime';

const posts = (await getCollection('blog')).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const searchData = posts.map((post) => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description,
	topics: post.data.topics,
	pubDate: post.data.pubDate.toISOString(),
	type: post.data.type,
	readingTime: formatReadingTime(calculateReadingTime(post.data.description ?? '')),
	url: `/blog/${post.id}/`,
}));
---

<div class="command-palette" data-command-palette data-open="false" aria-hidden="true">
	<div class="command-overlay" data-command-dismiss></div>
	<div class="command-dialog" role="dialog" aria-modal="true" aria-labelledby="command-palette-title">
		<div class="command-header">
			<div>
				<p class="command-title" id="command-palette-title">Quick Search</p>
				<p class="command-subtitle">Find posts, topics, or jump directly (⌘K / Ctrl+K)</p>
			</div>
			<button class="command-close" type="button" data-command-close aria-label="Close command palette">Esc</button>
		</div>
		<div class="command-input-row">
			<svg viewBox="0 0 24 24" aria-hidden="true" class="command-input-icon">
				<circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="1.5" />
				<line x1="16.65" y1="16.65" x2="21" y2="21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
			</svg>
			<input
				type="search"
				class="command-input"
				placeholder="Search posts..."
				autocomplete="off"
				spellcheck="false"
				data-command-input
			/>
		</div>
		<div class="command-results" data-command-results>
			<!-- Results rendered via script -->
		</div>
	</div>
</div>

<script is:inline define:vars={{ searchData }}>
	import Fuse from 'fuse.js';

	const palette = document.querySelector('[data-command-palette]');
	if (palette && palette.dataset.initialized !== 'true') {
		palette.dataset.initialized = 'true';
		const overlay = palette.querySelector('[data-command-dismiss]') as HTMLElement | null;
		const closeBtn = palette.querySelector('[data-command-close]') as HTMLButtonElement | null;
		const input = palette.querySelector('[data-command-input]') as HTMLInputElement | null;
		const results = palette.querySelector('[data-command-results]') as HTMLElement | null;
		const triggers = document.querySelectorAll('[data-command-trigger]');
		const fuse = new Fuse(searchData, {
			keys: ['title', 'description', 'topics'],
			threshold: 0.35,
			distance: 100,
			ignoreLocation: true,
		});

		let isOpen = false;
		let activeIndex = 0;
		let activeItems = [];
		let actionItems = [];
		let lastResults = [];

		const getInitialItems = () => searchData.slice(0, 6);

		const renderResults = (items) => {
			if (!results) return;
			lastResults = items;
			const combined = [...actionItems, ...items];
			activeItems = combined;
			if (combined.length === 0) {
				results.innerHTML = '<p class="command-empty">No matches found.</p>';
				return;
			}
			const html = combined
				.slice(0, 8)
				.map((item, index) => {
					const topics = item.topics?.length ? item.topics.join(', ') : '';
					const actionAttr = item.action ? `data-action="${item.action}"` : `data-href="${item.url}"`;
					const meta = item.action ? item.description ?? 'Quick action' : `${item.type ?? 'Post'} · ${item.readingTime}`;
					return `
						<button class="command-item" type="button" data-command-item data-index="${index}" ${actionAttr}>
							<div class="command-item-main">
								<p class="command-item-title">${item.title}</p>
								<p class="command-item-meta">${meta}</p>
							</div>
							<p class="command-item-topics">${item.action ? '' : topics}</p>
						</button>
					`;
				})
				.join('');
			results.innerHTML = html;
			activeIndex = Math.min(activeIndex, activeItems.length - 1);
			if (activeIndex < 0) activeIndex = 0;
			updateActiveItem();
		};

		const updateActiveItem = () => {
			const items = results?.querySelectorAll('[data-command-item]');
			if (!items) return;
			items.forEach((item) => item.classList.remove('active'));
			const activeItem = items[activeIndex];
			if (activeItem) {
				activeItem.classList.add('active');
			}
		};

		const openPalette = () => {
			if (isOpen) return;
			isOpen = true;
			palette.dataset.open = 'true';
			palette.setAttribute('aria-hidden', 'false');
			document.documentElement.classList.add('command-open');
			activeIndex = 0;
			renderResults(getInitialItems());
			requestAnimationFrame(() => {
				input?.focus();
				input?.select();
			});
		};

		const closePalette = () => {
			if (!isOpen) return;
			isOpen = false;
			palette.dataset.open = 'false';
			palette.setAttribute('aria-hidden', 'true');
			document.documentElement.classList.remove('command-open');
			if (input) {
				input.value = '';
			}
		};

		const handleAction = async (action) => {
			if (!action) return;
			if (action === 'copy-markdown' && window.llmAssistant?.copyMarkdown) {
				await window.llmAssistant.copyMarkdown();
			}
			closePalette();
		};

		const executeActiveItem = () => {
			if (!activeItems.length) return;
			const item = activeItems[activeIndex];
			if (item?.action) {
				handleAction(item.action);
				return;
			}
			if (item?.url) {
				window.location.href = item.url;
			}
			closePalette();
		};

		const handleInput = (event) => {
			const value = event.target.value.trim();
			if (value.length === 0) {
				renderResults(getInitialItems());
				return;
			}
			const matches = fuse.search(value).map((result) => result.item);
			activeIndex = 0;
			renderResults(matches.slice(0, 8));
		};

		const moveSelection = (delta) => {
			if (!activeItems.length) return;
			activeIndex = (activeIndex + delta + activeItems.length) % activeItems.length;
			updateActiveItem();
		};

		input?.addEventListener('input', handleInput);
		input?.addEventListener('keydown', (event) => {
			if (event.key === 'ArrowDown') {
				event.preventDefault();
				moveSelection(1);
			} else if (event.key === 'ArrowUp') {
				event.preventDefault();
				moveSelection(-1);
			} else if (event.key === 'Enter') {
				event.preventDefault();
				executeActiveItem();
			}
		});

		results?.addEventListener('click', (event) => {
			const target = (event.target as HTMLElement)?.closest('[data-command-item]');
			if (!target) return;
			const action = target.getAttribute('data-action');
			const href = target.getAttribute('data-href');
			if (action) {
				handleAction(action);
				return;
			}
			if (href) {
				window.location.href = href;
				closePalette();
			}
		});

		const globalShortcut = (event) => {
			if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === 'k') {
				event.preventDefault();
				if (isOpen) {
					closePalette();
				} else {
					openPalette();
				}
			}
			if (event.key === 'Escape' && isOpen) {
				closePalette();
			}
		};

		document.addEventListener('keydown', globalShortcut);
		closeBtn?.addEventListener('click', closePalette);
		overlay?.addEventListener('click', closePalette);
		triggers.forEach((trigger) => {
			trigger.addEventListener('click', (event) => {
				if (trigger.tagName === 'A') {
					event.preventDefault();
				}
				openPalette();
			});
		});

		document.addEventListener('llm:ready', (event) => {
			const detail = (event as CustomEvent).detail;
			if (!detail) return;
			actionItems = [
				{
					title: 'Copy page as Markdown',
					description: 'LLM-ready export for this page',
					action: 'copy-markdown',
				},
			];
			if (isOpen) {
				renderResults(lastResults);
			}
		});
	}
</script>

<style>
	:global(html.command-open) {
		overflow: hidden;
	}

	.command-palette {
		position: fixed;
		inset: 0;
		display: flex;
		align-items: flex-start;
		justify-content: center;
		padding: 3rem 1rem;
		z-index: 2000;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.2s ease;
	}

	.command-palette[data-open='true'] {
		pointer-events: auto;
		opacity: 1;
	}

	.command-overlay {
		position: fixed;
		inset: 0;
		background: rgba(15, 23, 42, 0.45);
		backdrop-filter: blur(6px);
	}

	.command-dialog {
		width: min(640px, 100%);
		background: var(--background);
		border-radius: 16px;
		border: 1px solid rgba(var(--gray-light), 0.8);
		box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
		position: relative;
		z-index: 1;
		display: flex;
		flex-direction: column;
		gap: 1rem;
		padding: 1.25rem 1.25rem 1.5rem;
	}

	[data-theme='dark'] .command-dialog {
		background: rgba(17, 24, 39, 0.95);
		border-color: rgba(75, 85, 99, 0.6);
	}

	.command-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.command-title {
		margin: 0;
		font-size: 1rem;
		font-weight: 600;
		color: rgb(var(--black));
	}

	.command-subtitle {
		margin: 0.15rem 0 0;
		font-size: 0.85rem;
		color: rgb(var(--gray));
	}

	.command-close {
		border: 1px solid rgba(var(--gray-light), 0.8);
		background: transparent;
		border-radius: 6px;
		padding: 0.15rem 0.45rem;
		font-size: 0.75rem;
		color: rgb(var(--gray));
	}

	.command-input-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		border: 1px solid rgba(var(--gray-light), 0.8);
		border-radius: 10px;
		padding: 0.35rem 0.85rem;
		background: rgba(var(--background), 0.6);
	}

	.command-input-icon {
		width: 18px;
		height: 18px;
		color: rgb(var(--gray));
	}

	.command-input {
		flex: 1;
		border: none;
		background: transparent;
		font-size: 1rem;
		color: rgb(var(--black));
		outline: none;
		padding: 0.5rem 0;
	}

	.command-results {
		max-height: 360px;
		overflow-y: auto;
		border-radius: 12px;
		border: 1px solid rgba(var(--gray-light), 0.6);
	}

	.command-item {
		width: 100%;
		text-align: left;
		padding: 0.85rem 1rem;
		border: none;
		background: transparent;
		display: flex;
		flex-direction: column;
		gap: 0.3rem;
		cursor: pointer;
		border-bottom: 1px solid rgba(var(--gray-light), 0.4);
	}

	.command-item:last-child {
		border-bottom: none;
	}

	.command-item.active,
	.command-item:hover {
		background: rgba(var(--accent-rgb), 0.08);
	}

	.command-item-main {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1rem;
	}

	.command-item-title {
		margin: 0;
		font-weight: 600;
		color: rgb(var(--black));
	}

	.command-item-meta {
		margin: 0;
		font-size: 0.8rem;
		color: rgb(var(--gray));
	}

	.command-item-topics {
		margin: 0;
		font-size: 0.78rem;
		color: rgb(var(--gray));
	}

	.command-empty {
		margin: 0;
		padding: 1rem;
		text-align: center;
		color: rgb(var(--gray));
	}

	@media (max-width: 640px) {
		.command-dialog {
			padding: 1rem;
			gap: 0.75rem;
		}
		.command-subtitle {
			font-size: 0.78rem;
		}
	}
</style>
